name: Run flutter tests
on:
  workflow_call:
    inputs:
      app-dir:
        required: true
        type: string
      android_keystore_path:
        required: true
        default: 'upload.jks'
        type: string
      android_keystore_alias:
        required: true
        default: 'upload'
        type: string
      environment: # options development|staging|production
        required: true
        type: string
      packageName: # this should be optional.. https://github.com/r0adkll/upload-google-play/issues/103
        required: true
        type: string

    secrets:
      android_key_properties_asc:
        required: true
      android_key_properties_passphrase:
        required: true
      android_keystore_password:
        required: true
      play_store_gservice_account:
        required: true

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin' # See 'Supported distributions' for available optionsjava-version
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Decrypt keystore
        run: |
          echo "${{secrets.android_key_properties_asc}}" > key.properties.asc
          echo "${{secrets.android_keystore_asc}}" > upload-keystore.jks.asc
          gpg -d --passphrase "${{ secrets.android_key_properties_passphrase }}" --batch key.properties.asc > key.properties
          gpg -d --passphrase "${{ secrets.android_keystore_passphrase }}" --batch upload-keystore.jks.asc > upload-keystore.jks
        working-directory: ${{ inputs.app-dir }}/android
      - run: flutter build appbundle  --release --flavor ${{ inputs.environment }} --target='lib/main.dart'
        working-directory: ${{ inputs.app-dir }}
        env:
          ANDROID_KEYSTORE_PATH: ${{ inputs.android_keystore_path }}
          ANDROID_KEYSTORE_ALIAS: ${{ inputs.android_keystore_alias }}
          ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD: ${{ secrets.android_keystore_private_key_password }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.android_keystore_password }}
      # - name: Release APPBUNDLE to internal track
      #   uses: r0adkll/upload-google-play@v1.0.16
      #   with:
      #     serviceAccountJsonPlainText: ${{ secrets.play_store_gservice_account }}
      #     releaseFile: ${{ inputs.app-dir }}/build/app/outputs/bundle/productionRelease/app-${{ inputs.environment }}-release.aab
      #     status: 'draft'
      #     track: internal
      #     packageName: ${{inputs.packageName}}
